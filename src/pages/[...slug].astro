---
import BaseLayout from '../layouts/BaseLayout.astro';
import DocsLayout from '../layouts/DocsLayout.astro';

function getSlug(filePath: string): string {
  return filePath.replace('/src/docs/', '').replace('.svx', '').replace(/\/index$/, '');
}

export async function getStaticPaths() {
  const modules = import.meta.glob('/src/docs/**/*.svx')


  return Promise.all(
    Object.entries(modules).map(async ([path, load]) => {
      const relative = path.split('/src/docs/')[1]
      const slug = relative.replace(/\.svx$/, '').replace(/\/index$/, '');


      const mod = (await load()) as { metadata?: Record<string, unknown> }

      return {
        params: { slug, aboba: path },
        props: { metadata: mod.metadata || {} },
      }
    })
  )
}

const { slug } = Astro.params
const {metadata: preloadedMeta } = Astro.props;

const docs = import.meta.glob('/src/docs/**/*.svx');
const filePath = Object.keys(docs).find((path) => getSlug(path) === slug);

if (!filePath) return Astro.redirect('/');


const allDocs = await Promise.all(
  Object.entries(docs).map(async ([path, importDoc]) => {
    const mod = (await importDoc()) as any;
    return {
      slug: getSlug(path),
      title: mod.metadata?.title ?? getSlug(path),
    };
  })
);

const doc = (await docs[filePath]!()) as any;
---

<BaseLayout>
  <DocsLayout
    items={allDocs}
    currentSlug={slug}
    title={preloadedMeta?.title ?? slug}
  >
    <doc.default />
  </DocsLayout>
</BaseLayout>
