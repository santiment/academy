---
import type { CollectionEntry } from 'astro:content'

import { getCollection, render } from 'astro:content'

import Page from '$layouts/Page.astro'
import Document from '$layouts/Document.astro'

import * as Headings from '$components/markdown/headings'
import Link from '$components/markdown/Link.svelte'
import Blockquote from '$components/markdown/Blockquote.svelte'

import { getSidebar, ROOT_SECTIONS } from '$modules/navigation/sidebar'
import { getFirstDocInSection } from '$modules/docs/engine'
import { getBreadcrumbs } from '$modules/navigation/breadcrumbs'

export async function getStaticPaths() {
  const allDocs = await getCollection('docs')
  const sidebarData = getSidebar(allDocs)

  const docsMap = new Map(allDocs.map((d) => [d.id, d]))

  const prepareProps = (doc: CollectionEntry<'docs'>) => ({
    params: { slug: doc.id },
    props: {
      doc,
      sidebarData,
      breadcrumbs: getBreadcrumbs(doc.id, docsMap),
    },
  })

  const docPaths = allDocs.map(prepareProps)

  const sectionPaths = Object.keys(ROOT_SECTIONS).map((section) => {
    const firstDoc = getFirstDocInSection(allDocs, section)

    return {
      params: { slug: section },
      props: {
        doc: firstDoc,
        sidebarData,
        breadcrumbs: getBreadcrumbs(firstDoc?.id ?? section, docsMap),
      },
    }
  })

  return [...docPaths, ...sectionPaths]
}

const { doc, sidebarData, breadcrumbs } = Astro.props

if (!doc) return Astro.redirect('/404')

const { Content, headings } = await render(doc)

const components = {
  h1: Headings.H1,
  h2: Headings.H2,
  h3: Headings.H3,
  h4: Headings.H4,
  h5: Headings.H5,
  a: Link,
  blockquote: Blockquote,
}

const formattedHeadings = headings.filter((h) => h.depth <= 3)
---

<Page title={`${doc.data.title} | Santiment Academy`}>
  <Document {doc} {breadcrumbs} {sidebarData} headings={formattedHeadings}>
    <Content {components} />
  </Document>
</Page>
