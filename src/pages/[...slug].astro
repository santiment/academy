---
import BaseLayout from '../layouts/BaseLayout.astro';
import DocsLayout from '../layouts/DocsLayout.astro';
import Pre from '../components/markdown/Pre/Pre.astro'
import { getCollection, getEntry, render } from 'astro:content';

export async function getStaticPaths() {
  const allDocs = await getCollection('docs'); 
  
  return allDocs.map((doc) => ({
    params: { slug: doc.id },
  }));
}

const { slug } = Astro.params;

const currentDoc = await getEntry('docs', slug || 'index');

if (!currentDoc) {
  return Astro.redirect('/404');
}

const allDocsEntries = await getCollection('docs');

const allDocs = allDocsEntries.map((entry) => ({
  pathname: entry.id,
  label: entry.data.title ?? entry.id, 
}));

const { Content } = await render(currentDoc);

const getBreadcrumbs = (path: string) => {
  const parts = path.split('/');
  let currentPath = '';
  const pathsToFind: string[] = [];

  parts.forEach((part, index) => {
    if (index > 0) {
      currentPath += '/';
    }
    currentPath += part;
    
    pathsToFind.push(currentPath);
  });
  
  if (path !== 'index') {
     pathsToFind.unshift('index');
  }


  const breadcrumbs = allDocs.filter(doc => pathsToFind.includes(doc.pathname));
  
  breadcrumbs.sort((a, b) => pathsToFind.indexOf(a.pathname) - pathsToFind.indexOf(b.pathname));

  const finalBreadcrumbs = breadcrumbs.slice(0, -1);

  const lastCrumb = { 
    pathname: `/${currentDoc.id}`,
      label: currentDoc.data.title, 
  };

  return [...finalBreadcrumbs, lastCrumb];
};

const breadcrumbs = [{ pathname: '/', label: 'Home' }, ...getBreadcrumbs(currentDoc.id)]
---

<BaseLayout>
  <DocsLayout
    crumbs={breadcrumbs}
    currentSlug={currentDoc.id}
    title={currentDoc.data.title}
  >
    <Content components={{ pre: Pre }} />
  </DocsLayout>
</BaseLayout>
